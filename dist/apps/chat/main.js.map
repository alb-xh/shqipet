{"version":3,"file":"main.js","mappings":"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","sources":["webpack:///external commonjs \"tslib\"","webpack:///external commonjs \"@nestjs/core\"","webpack:///./src/app/app.module.ts","webpack:///external commonjs \"@nestjs/common\"","webpack:///./src/app/geo-map.service.ts","webpack:///./src/app/chat.gateway.ts","webpack:///external commonjs \"@nestjs/websockets\"","webpack:///external commonjs \"socket.io\"","webpack:///./src/app/events.ts","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["module.exports = require(\"tslib\");","module.exports = require(\"@nestjs/core\");","import { Module } from '@nestjs/common';\nimport { GeoMapService } from './geo-map.service';\nimport { ChatGateway } from './chat.gateway';\n\n@Module({\n  imports: [],\n  providers: [ GeoMapService, ChatGateway ],\n})\nexport class AppModule {}\n","module.exports = require(\"@nestjs/common\");","import { ForbiddenException, Injectable } from \"@nestjs/common\";\nimport { GeoInfo } from \"@shqipet/geo\";\n\nexport type IdMap = Map<string, GeoInfo>;\nexport type GeoMapEntry = { active: number };\nexport type GeoMap = Map<GeoInfo, GeoMapEntry>;\n\nInjectable()\nexport class GeoMapService {\n  private readonly idMap: IdMap = new Map();\n  private readonly geoMap: GeoMap = new Map();\n  private readonly defaultGeo: GeoMapEntry = {\n    active: 0,\n  };\n\n  add (id: string, geo: GeoInfo): GeoMap {\n    if (this.idMap.get(id)) {\n      throw new ForbiddenException();\n    }\n\n    this.idMap.set(id, geo);\n\n    const geoEntry = this.geoMap.get(geo) || { ...this.defaultGeo };\n    geoEntry.active++;\n\n    return { ...this.geoMap };\n  }\n\n  remove (id: string): GeoMap {\n    const geo = this.idMap.get(id);\n\n    if (geo) {\n      throw new ForbiddenException();\n    }\n\n    const geoEntry = this.geoMap.get(geo);\n\n    if (!geoEntry || geoEntry.active <= 0) {\n      throw new ForbiddenException();\n    }\n\n    geoEntry.active--;\n\n    return { ...this.geoMap };\n  }\n}\n","import {\n  WebSocketGateway,\n  WebSocketServer,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n} from '@nestjs/websockets';\nimport { GeoInfo } from '@shqipet/geo';\nimport { Server, Socket } from 'socket.io';\n\nimport { Event } from './events';\nimport { GeoMapService } from './geo-map.service';\n\nconsole.log(process.env['DOMAIN']);\n\n@WebSocketGateway({ path: '/chat', cors: { origin: process.env['NODE'+'_ENV']['DOMAIN'] } })\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\n  @WebSocketServer() server: Server;\n\n  constructor (private readonly geoMapService: GeoMapService) {}\n\n  async handleConnection(client: Socket, geo: GeoInfo) {\n    this.server.emit(Event.GeoMap, this.geoMapService.add(client.id, geo));\n  }\n\n  async handleDisconnect(client: Socket) {\n    this.server.emit(Event.GeoMap, this.geoMapService.remove(client.id));\n  }\n}","module.exports = require(\"@nestjs/websockets\");","module.exports = require(\"socket.io\");","export enum Event {\n  GeoMap = 'geo_map',\n  Message = 'message',\n};\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app/app.module';\nimport { Logger } from '@nestjs/common';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  await app.listen(5000);\n\n  Logger.log(`ðŸš€ Application is running on: http://localhost:5000/chat`);\n}\nbootstrap();"],"names":[],"sourceRoot":""}