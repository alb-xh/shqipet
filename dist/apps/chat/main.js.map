{"version":3,"file":"main.js","mappings":"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","sources":["webpack:///external commonjs \"tslib\"","webpack:///external commonjs \"@nestjs/core\"","webpack:///./src/app/app.module.ts","webpack:///external commonjs \"@nestjs/common\"","webpack:///external commonjs \"@nestjs/config\"","webpack:///../../libs/geo/src/index.ts","webpack:///../../libs/geo/src/lib/geo.module.ts","webpack:///../../libs/geo/src/lib/geo.service.ts","webpack:///external node-commonjs \"path\"","webpack:///external node-commonjs \"fs\"","webpack:///external commonjs \"@maxmind/geoip2-node\"","webpack:///./src/app/geo.map.ts","webpack:///./src/app/chat.gateway.ts","webpack:///external commonjs \"@nestjs/websockets\"","webpack:///external commonjs \"socket.io\"","webpack:///./src/app/events.ts","webpack:///../../libs/config/src/index.ts","webpack:///../../libs/config/src/lib/config.module.ts","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["module.exports = require(\"tslib\");","module.exports = require(\"@nestjs/core\");","import { Module } from '@nestjs/common';\nimport { ConfigModule } from '@shqipet/config';\nimport { GeoModule } from '@shqipet/geo';\n\nimport { GeoMap } from './geo.map';\nimport { ChatGateway } from './chat.gateway';\n\n@Module({\n  imports: [ ConfigModule, GeoModule ],\n  providers: [ GeoMap, ChatGateway ],\n})\nexport class AppModule {}\n","module.exports = require(\"@nestjs/common\");","module.exports = require(\"@nestjs/config\");","export * from './lib/geo.module';\nexport * from './lib/geo.service';\n","import { Module } from '@nestjs/common';\nimport { GeoService } from './geo.service';\n\n@Module({\n  providers: [ GeoService ],\n  exports: [ GeoService ],\n})\nexport class GeoModule {}\n","import { join } from 'path';\nimport { readFileSync } from 'fs';\n\nimport { Injectable } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\n\nimport { Reader as ReaderNode, ReaderModel } from '@maxmind/geoip2-node';\n\nexport interface GeoInfo {\n  name?: string,\n  code?: string,\n  city?: string,\n  lat?: number,\n  lng?: number,\n}\n\n@Injectable()\nexport class GeoService {\n  private reader: ReaderModel;\n\n  constructor (configService: ConfigService) {\n    const path = configService.getOrThrow('GEO_DB_PATH');\n    const fullPath = join(process.cwd(), path);\n    const file = readFileSync(fullPath);\n\n    this.reader = ReaderNode.openBuffer(file);\n  }\n\n  getInfo (ip: string): GeoInfo {\n    const {\n      country,\n      city,\n      location,\n    } = this.reader.city(ip);\n\n    return {\n      name: country?.names?.en,\n      code: country?.isoCode,\n      city: city?.names?.en,\n      lat: location?.latitude,\n      lng: location?.longitude,\n    }\n  }\n}\n","module.exports = require(\"path\");","module.exports = require(\"fs\");","module.exports = require(\"@maxmind/geoip2-node\");","import { ForbiddenException, Injectable } from \"@nestjs/common\";\nimport { GeoInfo } from \"@shqipet/geo\";\n\nexport type IGeoMap = Record<string, GeoInfo>;\n\nInjectable()\nexport class GeoMap {\n  private readonly geoMap: IGeoMap = {};\n\n  exists (id: string): boolean {\n    return !!this.geoMap[id];\n  }\n\n  get (id: string): GeoInfo {\n    if (!this.exists(id)) {\n      throw new ForbiddenException();\n    }\n\n    return { ...this.geoMap[id] };\n  }\n\n  getAll (): IGeoMap {\n    return { ...this.geoMap };\n  }\n\n  add (id: string, data: GeoInfo): this {\n    this.geoMap[id] = data;\n    return this;\n  }\n\n  remove (id: string): this {\n    if (this.exists(id)) {\n      delete this.geoMap[id];\n    }\n\n    return this;\n  }\n}\n","import {\n  WebSocketGateway,\n  WebSocketServer,\n  OnGatewayConnection,\n  OnGatewayDisconnect,\n} from '@nestjs/websockets';\nimport { GeoService } from '@shqipet/geo';\nimport { Server, Socket } from 'socket.io';\n\nimport { Event } from './events';\nimport { GeoMap } from './geo.map';\nimport { ConfigService } from '@nestjs/config';\n\n@WebSocketGateway({ path: '/chat', cors: { origin: '*' } })\nexport class ChatGateway implements OnGatewayConnection, OnGatewayDisconnect {\n  @WebSocketServer() server: Server;\n  private readonly domain: string;\n  private readonly devIp = '91.82.156.27';\n\n  constructor (\n    private readonly geoMap: GeoMap,\n    private readonly geoService: GeoService,\n    configService: ConfigService,\n  ) {\n    this.domain = configService.getOrThrow('DOMAIN');\n  }\n\n  private getIp (client: Socket): string {\n    return this.domain !== 'localhost'\n      ? client.handshake.headers['x-real-ip'] as string || client.handshake.address\n      : this.devIp;\n  }\n\n  async handleConnection (client: Socket) {\n    const ip = this.getIp(client);\n    if (!ip) {\n      return;\n    }\n\n    const geoInfo = this.geoService.getInfo(ip);\n\n    this.server.emit(\n      Event.UpdateGeoMap,\n      this.geoMap.add(client.id, geoInfo)\n        .getAll()\n    );\n  }\n\n  async handleDisconnect(client: Socket) {\n    this.server.emit(\n      Event.UpdateGeoMap,\n      this.geoMap.remove(client.id)\n        .getAll()\n    );\n  }\n}","module.exports = require(\"@nestjs/websockets\");","module.exports = require(\"socket.io\");","export enum Event {\n  UpdateGeoMap = 'update_geo_map',\n  NewMessage = 'new_message',\n};\n","export * from './lib/config.module';\n","import { Module } from '@nestjs/common';\nimport { ConfigService, ConfigModule as NestConfigModule } from '@nestjs/config';\n\nconst envFilePath = process.env['NODE' + '_ENV'] === 'production' ? '.prod.env' : '.dev.env';\n\n@Module({\n  imports: [ NestConfigModule.forRoot({ isGlobal: true, envFilePath  }) ],\n  providers: [ConfigService],\n  exports: [ConfigService],\n})\nexport class ConfigModule {}\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","import { NestFactory } from '@nestjs/core';\nimport { AppModule } from './app/app.module';\nimport { Logger } from '@nestjs/common';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n  await app.listen(5000);\n\n  Logger.log(`ðŸš€ Application is running on: http://localhost:5000/chat`);\n}\n\nbootstrap();"],"names":[],"sourceRoot":""}