{"version":3,"file":"main.js","mappings":";;;;;;;AAAA;;;;;;ACAA;;;;;;ACAA;;;;;;ACAA;;;;;;;;;;ACAA,wCAAwC;AACxC,wCAA+C;AAC/C,sCAA2C;AAE3C,qCAAoC;AAM7B,IAAM,SAAS,GAAf,MAAM,SAAS;CAAG;AAAZ,SAAS;IAJrB,mBAAM,EAAC;QACN,OAAO,EAAE,CAAE,qBAAY,EAAE,iBAAU,CAAE;QACrC,WAAW,EAAE,CAAE,iBAAY,CAAE;KAC9B,CAAC;GACW,SAAS,CAAG;AAAZ,8BAAS;;;;;;;;;;ACVtB,sDAAoC;;;;;;;;;;;ACApC,wCAAwC;AACxC,wCAAiF;AAEjF,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC,MAAM,GAAG,MAAM,CAAC,KAAK,YAAY,CAAC,CAAC,CAAC,WAAW,CAAC,CAAC,CAAC,UAAU,CAAC;AAOtF,IAAM,YAAY,GAAlB,MAAM,YAAY;CAAG;AAAf,YAAY;IALxB,mBAAM,EAAC;QACN,OAAO,EAAE,CAAE,qBAAgB,CAAC,OAAO,CAAC,EAAE,QAAQ,EAAE,IAAI,EAAE,WAAW,EAAG,CAAC,CAAE;QACvE,SAAS,EAAE,CAAC,sBAAa,CAAC;QAC1B,OAAO,EAAE,CAAC,sBAAa,CAAC;KACzB,CAAC;GACW,YAAY,CAAG;AAAf,oCAAY;;;;;;;ACVzB;;;;;;;;;ACAA,uDAAkC;AAClC,uDAA0C;;;;;;;;;;;ACD1C,wCAAwC;AACxC,wCAA+C;AAC/C,sDAA0D;AAOnD,IAAM,UAAU,GAAhB,MAAM,UAAU;CAAG;AAAb,UAAU;IALtB,mBAAM,EAAC;QACN,OAAO,EAAE,CAAC,qBAAY,CAAC;QACvB,SAAS,EAAE,CAAC,uCAAiB,CAAC;QAC9B,OAAO,EAAE,CAAC,uCAAiB,CAAC;KAC7B,CAAC;GACW,UAAU,CAAG;AAAb,gCAAU;;;;;;;;;;;;ACRvB,wCAAgE;AAChE,wCAA+C;AAE/C,sDAAgE;AAGzD,IAAM,iBAAiB,GAAvB,MAAM,iBAAiB;IAI5B,YAAa,aAA4B;QACvC,MAAM,QAAQ,GAAG,aAAa,CAAC,UAAU,CAAC,kBAAkB,CAAC,CAAC;QAE9D,IAAI,CAAC,QAAQ,GAAG,QAAQ,CAAC;QACzB,IAAI,CAAC,WAAW,GAAG,IAAI,kCAAY,CAAC,QAAQ,CAAC,CAAC;IAChD,CAAC;IAEa,SAAS,CAAE,KAAa;;YACpC,OAAO,IAAI,CAAC,WAAW,CAAC,aAAa,CAAC;gBACpC,OAAO,EAAE,KAAK;gBACd,QAAQ,EAAE,IAAI,CAAC,QAAQ;aACxB,CAAC,CAAC;QACL,CAAC;KAAA;IAEK,OAAO,CAAE,KAAa;;YAC1B,IAAI;gBACF,MAAM,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;gBAC5B,OAAO,IAAI,CAAC;aACb;YAAC,WAAM;gBACN,OAAO,KAAK,CAAC;aACd;QACH,CAAC;KAAA;IAEK,OAAO,CAAE,KAAa;;YAC1B,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YAE3C,MAAM,EAAE,OAAO,EAAE,IAAI,EAAE,UAAU,EAAE,WAAW,EAAE,GAAG,MAAM,CAAC,UAAU,EAAE,CAAC;YAEvE,MAAM,QAAQ,GAAG,IAAI,IAAI,CAAE,UAAU,EAAE,WAAW,CAAE,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC/D,IAAI,CAAC,QAAQ,EAAE;gBACb,MAAM,IAAI,2BAAkB,CAAC,wBAAwB,CAAC,CAAC;aACxD;YAED,OAAO;gBACL,IAAI,EAAE,QAAQ;gBACd,MAAM,EAAE,OAAO;aAChB,CAAC;QACJ,CAAC;KAAA;CACF;AA1CY,iBAAiB;IAD7B,uBAAU,GAAE;iEAKiB,sBAAa,oBAAb,sBAAa;GAJ9B,iBAAiB,CA0C7B;AA1CY,8CAAiB;;;;;;;ACP9B;;;;;;;;;ACAA,2CAA4C;AAAnC,uHAAY;;;;;;;;;;;;ACArB,0CAA0D;AAC1D,wCAAmG;AACnG,wCAA+C;AAC/C,sCAAkD;AAG3C,IAAM,YAAY,GAAlB,MAAM,YAAY;IAOvB,YACmB,iBAAoC,EACrD,aAA4B;QADX,sBAAiB,GAAjB,iBAAiB,CAAmB;QANtC,kBAAa,GAAkB;YAC9C,QAAQ,EAAE,IAAI;YACd,QAAQ,EAAE,IAAI;SACf;QAMC,MAAM,UAAU,GAAG,aAAa,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;QACtD,MAAM,MAAM,GAAG,aAAa,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;QAElD,IAAI,CAAC,UAAU,GAAG,UAAU,CAAC;QAC7B,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,MAAM,CAAC;QACnC,IAAI,CAAC,aAAa,CAAC,MAAM,GAAG,MAAM,KAAK,WAAW,CAAC;IACrD,CAAC;IAGD,KAAK,CAAS,GAAY;QACxB,MAAM,MAAM,GAAG,GAAG,CAAC,OAAO,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;QAE5C,IAAI,CAAC,MAAM,EAAE;YACX,MAAM,IAAI,2BAAkB,EAAE,CAAC;SAChC;QAED,IAAI;YACF,MAAM,IAAI,GAAG,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;YACpD,OAAO,IAAI,CAAC;SACb;QAAC,WAAM;YACN,MAAM,IAAI,2BAAkB,EAAE,CAAC;SAChC;IACH,CAAC;IAGK,QAAQ,CAAiB,KAAa,EAAS,GAAa;;YAChE,IAAI,CAAC,KAAK,EAAE;gBACV,MAAM,IAAI,2BAAkB,EAAE,CAAC;aAChC;YAED,IAAI;gBACF,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC;gBAE3D,GAAG;qBACF,MAAM,CAAC,IAAI,CAAC,UAAU,EAAE,KAAK,EAAE,IAAI,CAAC,aAAa,CAAC;qBAClD,IAAI,CAAC,MAAM,CAAC,CAAC;aACf;YAAC,WAAM;gBACN,MAAM,IAAI,2BAAkB,EAAE,CAAC;aAChC;QACH,CAAC;KAAA;IAGD,QAAQ,CAAS,GAAa;QAC5B,GAAG;aACA,WAAW,CAAC,IAAI,CAAC,UAAU,EAAE,IAAI,CAAC,aAAa,CAAC;aAChD,IAAI,CAAC,EAAE,EAAE,EAAE,IAAI,EAAE,CAAC;IACvB,CAAC;CACF;AAvCC;IAAC,gBAAG,GAAE;IACE,mCAAG,GAAE;;iEAAM,iBAAO,oBAAP,iBAAO;;yCAazB;AAGK;IADL,iBAAI,GAAE;IACU,oCAAI,EAAC,OAAO,CAAC;IAAiB,mCAAG,GAAE;;yEAAM,kBAAQ,oBAAR,kBAAQ;gEAAG,OAAO,oBAAP,OAAO;4CAc3E;AAED;IAAC,mBAAM,GAAE;IACE,mCAAG,GAAE;;iEAAM,kBAAQ,oBAAR,kBAAQ;;4CAI7B;AAzDU,YAAY;IADxB,uBAAU,EAAC,KAAK,CAAC;iEASsB,wBAAiB,oBAAjB,wBAAiB,oDACtC,sBAAa,oBAAb,sBAAa;GATnB,YAAY,CA0DxB;AA1DY,oCAAY;;;;;;;ACNzB;;;;;UCAA;UACA;;UAEA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;UACA;;UAEA;UACA;;UAEA;UACA;UACA;;;;;;;;;;ACtBA;;;GAGG;AACH,wEAAyC;AAEzC,wCAAwD;AACxD,sCAA2C;AAE3C,4CAA6C;AAC7C,wCAA+C;AAE/C,SAAe,SAAS;;QACtB,MAAM,GAAG,GAAG,MAAM,kBAAW,CAAC,MAAM,CAAC,sBAAS,CAAC,CAAC;QAEhD,MAAM,IAAI,GAAG,IAAI,CAAC;QAClB,MAAM,MAAM,GAAG,KAAK,CAAC;QAErB,MAAM,aAAa,GAAG,GAAG,CAAC,GAAG,CAAC,sBAAa,CAAC,CAAC;QAC7C,MAAM,MAAM,GAAG,aAAa,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;QAElD,GAAG,CAAC,UAAU,CAAC,EAAE,WAAW,EAAE,IAAI,EAAE,MAAM,EAAE,IAAI,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;QAClE,GAAG,CAAC,GAAG,CAAC,2BAAY,GAAE,CAAC,CAAC;QACxB,GAAG,CAAC,eAAe,CAAC,MAAM,CAAC,CAAC;QAC5B,GAAG,CAAC,cAAc,CAAC,IAAI,uBAAc,EAAE,CAAC;QAExC,MAAM,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAEvB,eAAM,CAAC,GAAG,CAAC,kDAAkD,IAAI,IAAI,MAAM,EAAE,CAAC,CAAC;IACjF,CAAC;CAAA;AAED,SAAS,EAAE,CAAC","sources":["webpack:///external commonjs \"tslib\"","webpack:///external commonjs \"cookie-parser\"","webpack:///external commonjs \"@nestjs/common\"","webpack:///external commonjs \"@nestjs/core\"","webpack:///./src/app/app.module.ts","webpack:///../../libs/config/src/index.ts","webpack:///../../libs/config/src/lib/config.module.ts","webpack:///external commonjs \"@nestjs/config\"","webpack:///../../libs/auth/src/index.ts","webpack:///../../libs/auth/src/lib/auth.module.ts","webpack:///../../libs/auth/src/lib/google-auth.service.ts","webpack:///external commonjs \"google-auth-library\"","webpack:///./src/app/me/index.ts","webpack:///./src/app/me/controller.ts","webpack:///external commonjs \"express\"","webpack:///webpack/bootstrap","webpack:///./src/main.ts"],"sourcesContent":["module.exports = require(\"tslib\");","module.exports = require(\"cookie-parser\");","module.exports = require(\"@nestjs/common\");","module.exports = require(\"@nestjs/core\");","import { Module } from '@nestjs/common';\nimport { ConfigModule } from '@shqipet/config';\nimport { AuthModule } from '@shqipet/auth';\n\nimport { MeController } from './me';\n\n@Module({\n  imports: [ ConfigModule, AuthModule ],\n  controllers: [ MeController ],\n})\nexport class AppModule {}\n","export * from './lib/config.module';\n","import { Module } from '@nestjs/common';\nimport { ConfigService, ConfigModule as NestConfigModule } from '@nestjs/config';\n\nconst envFilePath = process.env['NODE' + '_ENV'] === 'production' ? '.prod.env' : '.dev.env';\n\n@Module({\n  imports: [ NestConfigModule.forRoot({ isGlobal: true, envFilePath  }) ],\n  providers: [ConfigService],\n  exports: [ConfigService],\n})\nexport class ConfigModule {}\n","module.exports = require(\"@nestjs/config\");","export * from './lib/auth.module';\nexport * from './lib/google-auth.service';\n","import { Module } from '@nestjs/common';\nimport { ConfigModule } from '@shqipet/config';\nimport { GoogleAuthService } from './google-auth.service';\n\n@Module({\n  imports: [ConfigModule],\n  providers: [GoogleAuthService],\n  exports: [GoogleAuthService],\n})\nexport class AuthModule {}\n","\nimport { ForbiddenException, Injectable } from \"@nestjs/common\";\nimport { ConfigService } from \"@nestjs/config\";\nimport { UserInfo } from \"@shqipet/common\";\nimport { LoginTicket, OAuth2Client } from 'google-auth-library';\n\n@Injectable()\nexport class GoogleAuthService {\n  private readonly clientId: string;\n  private readonly oAuthClient: OAuth2Client;\n\n  constructor (configService: ConfigService) {\n    const clientId = configService.getOrThrow('GOOGLE_CLIENT_ID');\n\n    this.clientId = clientId;\n    this.oAuthClient = new OAuth2Client(clientId);\n  }\n\n  private async getTicket (token: string): Promise<LoginTicket> {\n    return this.oAuthClient.verifyIdToken({\n      idToken: token,\n      audience: this.clientId\n    });\n  }\n\n  async isValid (token: string): Promise<boolean> {\n    try {\n      await this.getTicket(token);\n      return true;\n    } catch {\n      return false;\n    }\n  }\n\n  async getUser (token: string): Promise<UserInfo> {\n    const ticket = await this.getTicket(token);\n\n    const { picture, name, given_name, family_name } = ticket.getPayload();\n\n    const userName = name || [ given_name, family_name ].join(' ');\n    if (!userName) {\n      throw new ForbiddenException('User must have a name!');\n    }\n\n    return {\n      name: userName,\n      avatar: picture,\n    };\n  }\n}\n","module.exports = require(\"google-auth-library\");","export { MeController } from './controller';\n","import { Response, Request, CookieOptions} from 'express';\nimport { Body, Controller, Delete, ForbiddenException, Get, Post, Req, Res } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { GoogleAuthService } from '@shqipet/auth';\n\n@Controller('/me')\nexport class MeController {\n  private readonly cookieName;\n  private readonly cookieOptions: CookieOptions = {\n    httpOnly: true,\n    sameSite: true,\n  }\n\n  constructor(\n    private readonly googleAuthService: GoogleAuthService,\n    configService: ConfigService,\n  ) {\n    const cookieName = configService.getOrThrow('COOKIE');\n    const domain = configService.getOrThrow('DOMAIN');\n\n    this.cookieName = cookieName;\n    this.cookieOptions.domain = domain;\n    this.cookieOptions.secure = domain !== 'localhost';\n  }\n\n  @Get()\n  getMe (@Req() req: Request) {\n    const cookie = req.cookies[this.cookieName];\n\n    if (!cookie) {\n      throw new ForbiddenException();\n    }\n\n    try {\n      const user = this.googleAuthService.getUser(cookie);\n      return user;\n    } catch {\n      throw new ForbiddenException();\n    }\n  }\n\n  @Post()\n  async createMe (@Body('token') token: string, @Res() res: Response): Promise<void> {\n    if (!token) {\n      throw new ForbiddenException();\n    }\n\n    try {\n      const meData = await this.googleAuthService.getUser(token);\n\n      res\n      .cookie(this.cookieName, token, this.cookieOptions)\n      .send(meData);\n    } catch {\n      throw new ForbiddenException();\n    }\n  }\n\n  @Delete()\n  removeMe (@Res() res: Response): void {\n    res\n      .clearCookie(this.cookieName, this.cookieOptions)\n      .send({ ok: true })\n  }\n}\n","module.exports = require(\"express\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","/**\n * This is not a production server yet!\n * This is only a minimal backend to get started.\n */\nimport cookieParser from 'cookie-parser';\n\nimport { Logger, ValidationPipe } from '@nestjs/common';\nimport { NestFactory } from '@nestjs/core';\n\nimport { AppModule } from './app/app.module';\nimport { ConfigService } from '@nestjs/config';\n\nasync function bootstrap() {\n  const app = await NestFactory.create(AppModule);\n\n  const port = 3000;\n  const prefix = 'api';\n\n  const configService = app.get(ConfigService);\n  const origin = configService.getOrThrow('DOMAIN');\n\n  app.enableCors({ credentials: true, origin: new RegExp(origin) });\n  app.use(cookieParser());\n  app.setGlobalPrefix(prefix);\n  app.useGlobalPipes(new ValidationPipe())\n\n  await app.listen(port);\n\n  Logger.log(`🚀 Application is running on: http://localhost:${port}/${prefix}`);\n}\n\nbootstrap();\n"],"names":[],"sourceRoot":""}